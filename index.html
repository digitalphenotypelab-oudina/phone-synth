<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hydro-Challenge Immersion Pro</title>
    <style>
        body { margin: 0; background: #000428; color: white; font-family: 'Segoe UI', sans-serif; text-align: center; transition: background-color 0.3s; overflow: hidden; }
        .screen { display: none; height: 100vh; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        .active { display: flex; }
        
        button { padding: 18px 40px; margin: 10px; border-radius: 50px; border: none; background: #4cc9f0; color: #000428; font-weight: bold; font-size: 1.2rem; cursor: pointer; z-index: 10; box-shadow: 0 4px 20px rgba(0,210,255,0.4); }
        
        #score-display { font-size: 7rem; margin: 5px; color: #fff; text-shadow: 0 0 25px rgba(76, 201, 240, 0.9); transition: transform 0.2s; z-index: 10; }
        .score-pop { transform: scale(1.3); color: #f72585 !important; }
        
        #timer-display { font-size: 2.5rem; font-weight: bold; margin-bottom: 15px; z-index: 10; }
        
        #visual-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, #4361ee 0%, #000428 100%); opacity: 0.3; pointer-events: none; z-index: 1; }
        
        .leaderboard { background: rgba(255,255,255,0.05); padding: 25px; border-radius: 25px; border: 1px solid rgba(255,255,255,0.1); margin-top: 20px; min-width: 250px; }
        #loader { display: none; font-style: italic; color: #4cc9f0; margin: 15px; }
    </style>
</head>
<body>

    <div id="screen-home" class="screen active">
        <h1>HYDRO-CHALLENGE</h1>
        <button onclick="startMode('libre')">NAGE LIBRE</button>
        <button onclick="startMode('defi')">DÉFI 1 MINUTE</button>
        <div id="loader">Chargement des sons...</div>
        <div class="leaderboard">
            <h3>Top 3 Meilleurs Scores</h3>
            <div id="best-scores">Aucun score enregistré</div>
        </div>
    </div>

    <div id="screen-game" class="screen">
        <div id="visual-layer"></div>
        <div id="timer-display">--:--</div>
        <div id="score-display">0</div>
        <p style="z-index:10; letter-spacing: 2px;">MOUVEMENTS</p>
        <button onclick="stopGame()" style="background:#f72585; color:white; margin-top: 30px;">QUITTER</button>
    </div>

    <script>
        let audioCtx, source, filter, gainNode, compressor;
        let sounds = {};
        let score = 0;
        let timeLeft = 60;
        let isGaming = false;
        let canScore = true;
        let timerInterval;
        let goal5Intensity = 0.4; // Volume de départ des encouragements

        // Chargement sécurisé des fichiers
        async function loadSound(url) {
            const resp = await fetch(url);
            if (!resp.ok) throw new Error(`Fichier introuvable : ${url}`);
            return await audioCtx.decodeAudioData(await resp.arrayBuffer());
        }

        async function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                document.getElementById('loader').style.display = 'block';
                
                try {
                    const [waterB, g5B, g10B, g20B] = await Promise.all([
                        loadSound('water.mp3'),
                        loadSound('goal5.mp3'),
                        loadSound('goal10.mp3'),
                        loadSound('goal20.mp3')
                    ]);
                    sounds = { water: waterB, goal5: g5B, goal10: g10B, goal20: g20B };
                } catch (e) {
                    alert("Erreur : " + e.message);
                    document.getElementById('loader').style.display = 'none';
                    return false;
                }

                // Chaîne Audio : Source -> Filtre -> Gain -> Compresseur -> Sortie
                source = audioCtx.createBufferSource();
                source.buffer = sounds.water;
                source.loop = true;

                filter = audioCtx.createBiquadFilter();
                filter.type = 'lowpass';
                filter.frequency.value = 300;

                gainNode = audioCtx.createGain();
                gainNode.gain.value = 0.5;

                compressor = audioCtx.createDynamicsCompressor();
                // Paramètres pour "remonter" un son d'eau trop faible
                compressor.threshold.setValueAtTime(-24, audioCtx.currentTime);
                compressor.ratio.setValueAtTime(12, audioCtx.currentTime);

                source.connect(filter).connect(gainNode).connect(compressor).connect(audioCtx.destination);
                source.start();
            }
            return true;
        }

        function playReward(buffer, vol) {
            const rSource = audioCtx.createBufferSource();
            const rGain = audioCtx.createGain();
            rSource.buffer = buffer;
            rGain.gain.value = vol;
            rSource.connect(rGain).connect(audioCtx.destination);
            rSource.start();
        }

        async function startMode(m) {
            const ready = await initAudio();
            if (!ready) return;

            score = 0;
            goal5Intensity = 0.4;
            document.getElementById('score-display').innerText = "0";
            document.getElementById('loader').style.display = 'none';
            
            if (typeof DeviceMotionEvent.requestPermission === 'function') {
                await DeviceMotionEvent.requestPermission();
            }
            window.addEventListener('devicemotion', handleMotion);

            document.getElementById('screen-home').classList.remove('active');
            document.getElementById('screen-game').classList.add('active');
            isGaming = true;

            if (m === 'defi') {
                timeLeft = 60;
                document.getElementById('timer-display').innerText = "1:00";
                timerInterval = setInterval(updateTimer, 1000);
            } else {
                document.getElementById('timer-display').innerText = "Nage Libre";
            }
        }

        function updateTimer() {
            timeLeft--;
            document.getElementById('timer-display').innerText = `0:${timeLeft < 10 ? '0'+timeLeft : timeLeft}`;
            if (timeLeft <= 0) endGame();
        }

        function handleMotion(event) {
            if (!isGaming) return;
            const acc = event.acceleration;
            if (!acc || !acc.x) return;

            let mag = Math.sqrt(acc.x**2 + acc.y**2 + acc.z**2);

            // Mixage eau : Gain plus sensible pour compenser le fichier non-normalisé
            let tGain = Math.max(0.5, Math.min(2.5, mag / 2.5));
            gainNode.gain.setTargetAtTime(tGain, audioCtx.currentTime, 0.1);
            filter.frequency.setTargetAtTime(300 + (mag * 500), audioCtx.currentTime, 0.1);

            // Détection du mouvement (Crawl/Brasse)
            if (mag > 15 && canScore) {
                score++;
                triggerPointEffects(score);
                canScore = false;
                setTimeout(() => { canScore = true; }, 650); 
            }
        }

        function triggerPointEffects(s) {
            const el = document.getElementById('score-display');
            el.innerText = s;
            el.classList.add('score-pop');
            setTimeout(() => el.classList.remove('score-pop'), 250);

            // Paliers de récompenses
            if (s === 10) {
                playReward(sounds.goal10, 0.6); // Volume modéré
                flashScreen('#4cc9f0');
                goal5Intensity += 0.15;
            } else if (s === 20) {
                playReward(sounds.goal20, 0.7);
                flashScreen('#f72585');
                goal5Intensity += 0.15;
            } else if (s % 5 === 0) {
                playReward(sounds.goal5, goal5Intensity);
                flashScreen('#4361ee');
            }
            
            if (navigator.vibrate) navigator.vibrate(60);
        }

        function flashScreen(color) {
            document.body.style.backgroundColor = color;
            setTimeout(() => { document.body.style.backgroundColor = "#000428"; }, 350);
        }

        function stopGame() {
            isGaming = false;
            clearInterval(timerInterval);
            if (gainNode) gainNode.gain.setTargetAtTime(0, audioCtx.currentTime, 0.5);
            window.removeEventListener('devicemotion', handleMotion);
            document.getElementById('screen-game').classList.remove('active');
            document.getElementById('screen-home').classList.add('active');
            displayLeaderboard();
        }

        function endGame() {
            saveScore(score);
            alert(`Fin du temps ! Score final : ${score}`);
            stopGame();
        }

        function saveScore(s) {
            let scs = JSON.parse(localStorage.getItem('hydroScores') || "[]");
            scs.push(s);
            scs.sort((a,b) => b-a);
            localStorage.setItem('hydroScores', JSON.stringify(scs.slice(0,3)));
        }

        function displayLeaderboard() {
            let scs = JSON.parse(localStorage.getItem('hydroScores') || "[]");
            document.getElementById('best-scores').innerHTML = scs.length ? 
                scs.map((s,i)=>`<b>${i+1}.</b> ${s} mouvements`).join('<br>') : "Aucun score";
        }

        displayLeaderboard();
    </script>
</body>
</html>
