<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eau Thérapeutique</title>
    <style>
        body { margin: 0; background: #000428; color: white; font-family: sans-serif; display: flex; align-items: center; justify-content: center; height: 100vh; overflow: hidden; }
        #interface { text-align: center; z-index: 10; }
        button { padding: 20px 40px; border-radius: 50px; border: none; background: #00d2ff; color: #000428; font-weight: bold; font-size: 1.2rem; cursor: pointer; box-shadow: 0 0 20px #00d2ff; }
        #visual { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, #004e92 0%, #000428 100%); transition: opacity 0.5s; opacity: 0.5; }
    </style>
</head>
<body>
    <div id="visual"></div>
    <div id="interface">
        <h1>Sensation Aquatique</h1>
        <button id="btn">ENTRER DANS L'EAU</button>
        <p id="msg">Assurez-vous que 'water.wav' est bien dans le dossier.</p>
    </div>

    <script>
        let audioCtx, source, filter, gainNode;
        let isPlaying = false;

        document.getElementById('btn').addEventListener('click', async () => {
            if (isPlaying) return;

            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            
            // Chargement du fichier MP3
            const response = await fetch('water.wav');
            const arrayBuffer = await response.arrayBuffer();
            const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);

            source = audioCtx.createBufferSource();
            source.buffer = audioBuffer;
            source.loop = true;

            // Filtre pour l'effet "profondeur"
            filter = audioCtx.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.value = 400;

            gainNode = audioCtx.createGain();
            gainNode.gain.value = 0.5;

            source.connect(filter);
            filter.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            source.start();
            isPlaying = true;
            document.getElementById('btn').style.display = 'none';

            // Activation des capteurs
            if (typeof DeviceMotionEvent.requestPermission === 'function') {
                const res = await DeviceMotionEvent.requestPermission();
                if (res === 'granted') window.addEventListener('devicemotion', handleMovement);
            } else {
                window.addEventListener('devicemotion', handleMovement);
            }
        });

        function handleMovement(event) {
            const acc = event.acceleration;
            const rot = event.accelerationIncludingGravity; // Pour l'inclinaison

            // 1. Vitesse de mouvement = Vitesse de l'eau
            let speed = Math.sqrt(acc.x**2 + acc.y**2 + acc.z**2);
            let playbackRate = 0.8 + (speed / 10); 
            source.playbackRate.setTargetAtTime(Math.min(1.5, playbackRate), audioCtx.currentTime, 0.1);

            // 2. Inclinaison (Axe Z ou Y) = Profondeur
            // Si le téléphone pointe vers le bas, on filtre les aigus (immersion totale)
            let depth = Math.abs(rot.z); 
            let cutoff = 200 + (depth * 400); 
            filter.frequency.setTargetAtTime(Math.min(2000, cutoff), audioCtx.currentTime, 0.1);

            // 3. Feedback visuel
            document.getElementById('visual').style.opacity = 0.3 + (speed / 15);
        }
    </script>
</body>
</html>
