<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Immersion Aquatique Pro</title>
    <style>
        body { margin: 0; background: #000428; color: white; font-family: 'Segoe UI', sans-serif; display: flex; align-items: center; justify-content: center; height: 100vh; overflow: hidden; }
        #interface { text-align: center; z-index: 10; pointer-events: none; }
        button { padding: 25px 50px; border-radius: 60px; border: none; background: #4cc9f0; color: #000428; font-weight: bold; font-size: 1.4rem; cursor: pointer; box-shadow: 0 0 30px rgba(76, 201, 240, 0.6); pointer-events: auto; }
        #visual { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, #4361ee 0%, #000428 100%); opacity: 0.2; transition: opacity 0.1s; }
        #loader { display: none; margin-top: 20px; color: #4cc9f0; }
    </style>
</head>
<body>
    <div id="visual"></div>
    <div id="interface">
        <button id="btn">COMMENCER L'IMMERSION</button>
        <div id="loader">Chargement de l'eau...</div>
    </div>

    <script>
        let audioCtx, source, filter, gainNode;
        let isPlaying = false;
        let lastMag = 0;

        const btn = document.getElementById('btn');
        const loader = document.getElementById('loader');

        btn.addEventListener('click', async () => {
            if (isPlaying) return;
            
            btn.style.display = 'none';
            loader.style.display = 'block';

            try {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                
                const response = await fetch('water.mp3');
                const arrayBuffer = await response.arrayBuffer();
                const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);

                source = audioCtx.createBufferSource();
                source.buffer = audioBuffer;
                source.loop = true;

                filter = audioCtx.createBiquadFilter();
                filter.type = 'lowpass';
                filter.frequency.value = 200; // Très sourd au repos

                gainNode = audioCtx.createGain();
                gainNode.gain.value = 0.05; // Quasiment silencieux au repos

                source.connect(filter);
                filter.connect(gainNode);
                gainNode.connect(audioCtx.destination);

                source.start();
                isPlaying = true;
                loader.innerText = "PRÊT : BOUGEZ VOTRE MAIN";

                if (typeof DeviceMotionEvent.requestPermission === 'function') {
                    const res = await DeviceMotionEvent.requestPermission();
                    if (res === 'granted') window.addEventListener('devicemotion', handleMovement);
                } else {
                    window.addEventListener('devicemotion', handleMovement);
                }
            } catch (e) {
                loader.innerText = "Erreur de chargement. Vérifiez water.mp3";
                console.error(e);
            }
        });

        function handleMovement(event) {
            const acc = event.acceleration;
            if (!acc || !acc.x) return;

            // 1. Calcul de la puissance du mouvement (Magnitude)
            let mag = Math.sqrt(acc.x**2 + acc.y**2 + acc.z**2);
            
            // 2. Lissage pour éviter les craquements (Filtre de transition)
            let smoothedMag = lastMag * 0.85 + mag * 0.15;
            lastMag = smoothedMag;

            // 3. MAPPING RÉALISTE
            // Volume : de 0.05 (repos) à 1.2 (mouvement fort)
            let targetGain = Math.max(0.05, Math.min(1.2, smoothedMag / 4));
            gainNode.gain.setTargetAtTime(targetGain, audioCtx.currentTime, 0.05);

            // Fréquence (Clarté) : plus on bouge, plus on entend les bulles du MP3
            let cutoff = 200 + (smoothedMag * 600);
            filter.frequency.setTargetAtTime(Math.min(3500, cutoff), audioCtx.currentTime, 0.1);

            // Vitesse de lecture : l'eau s'agite avec la vitesse
            let rate = 0.9 + (smoothedMag / 25);
            source.playbackRate.setTargetAtTime(Math.min(1.3, rate), audioCtx.currentTime, 0.1);

            // 4. Feedback Visuel
            document.getElementById('visual').style.opacity = 0.1 + (targetGain * 0.8);
        }
    </script>
</body>
</html>
